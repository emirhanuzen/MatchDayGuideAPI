<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsenal Match Day Guide</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; height: 100vh; background-color: #f0f0f0; }
        header { background-color: #EF0107; color: white; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 2000; }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .arsenal-logo { height: 50px; background: white; border-radius: 50%; padding: 2px; }
        h1 { margin: 0; font-size: 22px; text-transform: uppercase; letter-spacing: 1px; }
        .controls { background: #023474; color: white; padding: 15px; display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap; }
        select { padding: 8px 15px; border-radius: 20px; border: none; font-size: 16px; outline: none; cursor: pointer; color: #023474; font-weight: bold; }
        #map { flex-grow: 1; width: 100%; cursor: crosshair; }
        #bilgi-cubugu { background: #9C824A; color: white; text-align: center; padding: 10px; font-weight: bold; display: none; }
        .custom-icon { font-size: 24px; text-align: center; line-height: 30px; background: white; border-radius: 50%; border: 2px solid #EF0107; width: 30px !important; height: 30px !important; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .user-icon { border-color: #023474; background: #eef; }
        .target-icon { border-color: #27ae60; background: #eaffea; font-size: 28px; }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="https://www.freepnglogos.com/uploads/arsenal-logo-png/arsenal-logo-0.png" alt="Arsenal Logo" class="arsenal-logo">
            <div>
                <h1>Emirates Stadium</h1>
                <small style="opacity: 0.8;">Navigasyon & Rehber</small>
            </div>
        </div>
    </header>

    <div class="controls">
        <label>ğŸ” Ne ArÄ±yorsun?</label>
        <select id="kategori">
            <option value="WC">Tuvalet ğŸš»</option>
            <option value="Yemek">Yemek / BÃ¼fe ğŸ”</option>
            <option value="Kapi">GiriÅŸ KapÄ±sÄ± ğŸšª</option>
            <option value="Bar">Bar / Pub ğŸº</option>
        </select>
        <span style="font-size: 14px; opacity: 0.8;">(Haritada bulunduÄŸun yere tÄ±kla)</span>
    </div>

    <div id="bilgi-cubugu">...</div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. HARÄ°TAYI BAÅLAT
        var map = L.map('map').setView([51.5549, -0.1084], 17);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        var userMarker = null;
        var targetMarker = null;
        var routeLine = null;

        // 2. SAYFA AÃ‡ILINCA TÃœM MEKANLARI LÄ°STELE
        loadAllLocations();

        async function loadAllLocations() {
            try {
                // Senin backend endpoint'in: /stadiums/{stadium_id}/locations
                const res = await fetch("http://127.0.0.1:8000/stadiums/1/locations");
                const locations = await res.json();

                locations.forEach(loc => {
                    let ikon = 'ğŸ“';
                    if(loc.category === 'WC') ikon = 'ğŸš»';
                    if(loc.category === 'Yemek') ikon = 'ğŸ”';
                    if(loc.category === 'Kapi') ikon = 'ğŸšª';
                    if(loc.category === 'Bar') ikon = 'ğŸº';

                    L.marker([loc.lat, loc.lon], {
                        icon: L.divIcon({ className: 'custom-icon', html: ikon })
                    }).addTo(map).bindPopup(`<strong>${loc.name}</strong><br>${loc.description}`);
                });
            } catch(e) { console.error("Veri yÃ¼kleme hatasÄ±:", e); }
        }

        // 3. TIKLAMA VE REHBER (GUIDE) Ã‡ALIÅTIRMA
        map.on('click', async function(e) {
            var lat = e.latlng.lat;
            var lon = e.latlng.lng;
            var kat = document.getElementById("kategori").value;
            var bilgiCubugu = document.getElementById("bilgi-cubugu");

            // Temizlik
            if (userMarker) map.removeLayer(userMarker);
            if (targetMarker) map.removeLayer(targetMarker);
            if (routeLine) map.removeLayer(routeLine);

            // KullanÄ±cÄ± Ä°ÅŸaretÃ§isi
            userMarker = L.marker([lat, lon], {
                icon: L.divIcon({ className: 'custom-icon user-icon', html: 'ğŸƒ' })
            }).addTo(map);

            bilgiCubugu.style.display = "block";
            bilgiCubugu.innerHTML = "â³ En yakÄ±n nokta hesaplanÄ±yor...";

            try {
                // Senin Rehber Endpoint'in: /stadiums/{stadium_id}/guide?user_lat=...&user_lon=...&category=...
                const url = `http://127.0.0.1:8000/stadiums/1/guide?user_lat=${lat}&user_lon=${lon}&category=${kat}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.length === 0) {
                    bilgiCubugu.innerHTML = "âŒ YakÄ±nlarda bu kategoride bir yer bulunamadÄ±.";
                    return;
                }

                // API'den gelen ilk eleman (En yakÄ±nÄ±)
                const enYakin = data[0];

                // Hedefi Ä°ÅŸaretle
                targetMarker = L.marker([enYakin.lat, enYakin.lon], {
                    icon: L.divIcon({ className: 'custom-icon target-icon', html: 'â­' })
                }).addTo(map).bindPopup(`${enYakin.name} - ${enYakin.distance_meters}m`).openPopup();

                // Rota Ã‡izgisi
                routeLine = L.polyline([[lat, lon], [enYakin.lat, enYakin.lon]], {
                    color: '#EF0107',
                    weight: 5,
                    dashArray: '10, 10'
                }).addTo(map);

                bilgiCubugu.innerHTML = `âœ… GÄ°T: <b>${enYakin.name}</b> (${enYakin.distance_meters} metre)`;
                bilgiCubugu.style.backgroundColor = "#27ae60";

            } catch (err) {
                bilgiCubugu.innerHTML = "âš ï¸ BaÄŸlantÄ± hatasÄ±! Backend'i kontrol et.";
                bilgiCubugu.style.backgroundColor = "red";
            }
        });
    </script>
</body>
</html>